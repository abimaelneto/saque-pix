apiVersion: 1

contactPoints:
  - orgId: 1
    name: saque-pix-email-alerts
    receivers:
      - uid: saque-pix-email
        type: email
        settings:
          addresses: ${GRAFANA_ALERT_EMAIL:-alerts@saque-pix.local}

policies:
  - orgId: 1
    receiver: saque-pix-email-alerts
    group_by:
      - alertname
    routes: []

rules:
  - orgId: 1
    name: Saque PIX Alerts
    folder: Saque PIX
    interval: 1m
    rules:
      - uid: withdraw-error-rate
        title: "Taxa de erro de saques alta"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                sum(increase(withdraws_processed_total{status="error"}[5m])) 
                / sum(increase(withdraws_processed_total[5m]))
              hide: false
              interval: ""
              legendFormat: ""
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B > 0.05
              intervalMs: 1000
              maxDataPoints: 43200
              type: math
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          summary: "Mais de 5% dos saques falharam nos últimos 5 minutos."
        labels:
          severity: critical
        isPaused: false

      - uid: withdraw-processing-slow
        title: "Tempo médio de processamento elevado"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: avg_over_time(withdraw_processing_time_seconds[5m])
              hide: false
              interval: ""
              legendFormat: ""
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              reducer: last
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B > 2
              intervalMs: 1000
              maxDataPoints: 43200
              type: math
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          summary: "Tempo médio de processamento de saques ficou acima de 2s nos últimos 5 minutos."
        labels:
          severity: warning
        isPaused: false

