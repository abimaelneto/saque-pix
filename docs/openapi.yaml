openapi: 3.0.3
info:
  title: Saque PIX API
  description: |
    API para gerenciamento de saques PIX em contas digitais.
    
    ## Autenticação
    Todas as requisições requerem autenticação via JWT Bearer Token no header `Authorization`.
    
    ## Rate Limiting
    - Endpoints gerais: 100 requisições por minuto
    - Endpoint de saque: 10 requisições por minuto
    
    ## Códigos de Erro
    - `400`: Bad Request - Dados inválidos
    - `401`: Unauthorized - Token não fornecido ou inválido
    - `403`: Forbidden - Acesso negado (fraude detectada ou sem permissão)
    - `422`: Unprocessable Entity - Validação falhou
    - `429`: Too Many Requests - Rate limit excedido
    - `500`: Internal Server Error - Erro interno do servidor
  version: 1.0.0
  contact:
    name: Suporte API
    email: suporte@saque-pix.local

servers:
  - url: http://localhost:9501
    description: Servidor local de desenvolvimento
  - url: https://api.saque-pix.local
    description: Servidor de produção

tags:
  - name: Health
    description: Endpoints de saúde e métricas
  - name: Withdraw
    description: Operações de saque PIX

paths:
  /health:
    get:
      tags:
        - Health
      summary: Verificar saúde do sistema
      description: Retorna o status de saúde do sistema, incluindo verificações de banco de dados e Redis
      operationId: getHealth
      responses:
        '200':
          description: Sistema saudável
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Sistema degradado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /metrics:
    get:
      tags:
        - Health
      summary: Obter métricas do sistema
      description: Retorna métricas no formato Prometheus
      operationId: getMetrics
      responses:
        '200':
          description: Métricas retornadas com sucesso
          content:
            text/plain:
              schema:
                type: string
                example: |
                  withdraws_created_total{type="immediate",pix_type="email"} 150
                  withdraws_processed_total{status="success"} 145

  /metrics/json:
    get:
      tags:
        - Health
      summary: Obter métricas em formato JSON
      description: Retorna métricas em formato JSON estruturado
      operationId: getMetricsJson
      responses:
        '200':
          description: Métricas retornadas com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  /account/{accountId}/balance/withdraw:
    post:
      tags:
        - Withdraw
      summary: Criar saque PIX
      description: |
        Cria um saque PIX imediato ou agendado.
        
        ### Regras de Negócio:
        - Saldo deve ser suficiente (para saques imediatos)
        - Valor mínimo: R$ 0,01
        - Valor máximo: R$ 50.000,00
        - Data de agendamento não pode ser no passado
        - Rate limit: 10 requisições por minuto
        
        ### Detecção de Fraude:
        - Limite diário: R$ 10.000,00 ou 20 saques
        - Limite por hora: 5 saques
        - Valores acima de R$ 5.000,00 são marcados como suspeitos
      operationId: createWithdraw
      security:
        - bearerAuth: []
      parameters:
        - name: accountId
          in: path
          required: true
          description: ID da conta (UUID)
          schema:
            type: string
            format: uuid
            example: "550e8400-e29b-41d4-a716-446655440000"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WithdrawRequest'
            examples:
              immediate:
                summary: Saque imediato
                value:
                  method: "PIX"
                  pix:
                    type: "email"
                    key: "usuario@email.com"
                  amount: "100.50"
              scheduled:
                summary: Saque agendado
                value:
                  method: "PIX"
                  pix:
                    type: "email"
                    key: "usuario@email.com"
                  amount: "500.00"
                  schedule: "2024-12-31 23:59"
      responses:
        '201':
          description: Saque criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WithdrawResponse'
        '400':
          description: Requisição inválida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidAccount:
                  value:
                    error: "Account not found"
                insufficientBalance:
                  value:
                    error: "Insufficient balance"
                pastDate:
                  value:
                    error: "Cannot schedule withdraw for past date"
        '401':
          description: Não autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized: Token not provided or invalid format"
        '403':
          description: Acesso negado (fraude detectada)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Transaction blocked due to suspicious activity."
        '422':
          description: Validação falhou
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationErrorResponse'
              example:
                error: "Validation failed"
                messages:
                  - "The amount field is required."
                  - "The pix.key must be a valid email address."
        '429':
          description: Rate limit excedido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              headers:
                X-RateLimit-Limit:
                  schema:
                    type: integer
                  description: Limite de requisições
                X-RateLimit-Remaining:
                  schema:
                    type: integer
                  description: Requisições restantes
                X-RateLimit-Reset:
                  schema:
                    type: integer
                  description: Timestamp de reset do limite
              example:
                error: "Too Many Requests"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Token JWT no formato: `Bearer <token>`
        
        Exemplo:
        ```
        Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        ```

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded]
          example: "ok"
        timestamp:
          type: string
          format: date-time
          example: "2024-01-15T10:30:00Z"
        checks:
          type: object
          properties:
            database:
              type: string
              example: "ok"
            redis:
              type: string
              example: "ok"

    MetricsResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        metrics:
          type: object
          additionalProperties:
            type: array
            items:
              type: object
              properties:
                labels:
                  type: object
                value:
                  type: number
                stats:
                  type: object
                  properties:
                    count:
                      type: integer
                    sum:
                      type: number
                    min:
                      type: number
                    max:
                      type: number
                    avg:
                      type: number

    WithdrawRequest:
      type: object
      required:
        - method
        - pix
        - amount
      properties:
        method:
          type: string
          enum: [PIX]
          description: Método de saque (atualmente apenas PIX)
          example: "PIX"
        pix:
          type: object
          required:
            - type
            - key
          properties:
            type:
              type: string
              enum: [email, cpf, phone, random]
              description: Tipo de chave PIX
              example: "email"
            key:
              type: string
              description: Chave PIX (formato depende do tipo)
              example: "usuario@email.com"
          description: Dados da chave PIX
        amount:
          type: string
          pattern: '^\d+\.\d{2}$'
          description: Valor do saque (formato: "999.99")
          minimum: 0.01
          maximum: 50000.00
          example: "100.50"
        schedule:
          type: string
          format: date-time
          pattern: '^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$'
          description: Data e hora para agendamento (formato: "YYYY-MM-DD HH:mm"). Se não fornecido, o saque é processado imediatamente.
          example: "2024-12-31 23:59"

    WithdrawResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            id:
              type: string
              format: uuid
              example: "123e4567-e89b-12d3-a456-426614174000"
            account_id:
              type: string
              format: uuid
              example: "550e8400-e29b-41d4-a716-446655440000"
            method:
              type: string
              example: "PIX"
            amount:
              type: string
              example: "100.50"
            scheduled:
              type: boolean
              example: false
            scheduled_for:
              type: string
              format: date-time
              nullable: true
              example: null
            done:
              type: boolean
              description: Indica se o saque foi processado
              example: true
            error:
              type: boolean
              description: Indica se houve erro no processamento
              example: false
            error_reason:
              type: string
              nullable: true
              description: Motivo do erro (se houver)
              example: null
            created_at:
              type: string
              format: date-time
              example: "2024-01-15T10:30:00Z"

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Mensagem de erro
          example: "Account not found"

    ValidationErrorResponse:
      type: object
      properties:
        error:
          type: string
          example: "Validation failed"
        messages:
          type: array
          items:
            type: string
          example:
            - "The amount field is required."
            - "The pix.key must be a valid email address."

